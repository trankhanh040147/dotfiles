{"fsPath":"/home/khanh/.cursor/plans/fix_mode_selection_flow_04a51096.plan.md","fileUuid":"befccddf-d65d-4ed0-8a4e-3bb6604db246","fileSizeBytes":9084,"numLines":115,"diffChanges":[{"originalStartLineNumberOneIndexed":3,"originalEndLineNumberExclusiveOneIndexed":4,"modifiedStartLineNumberOneIndexed":3,"modifiedEndLineNumberExclusiveOneIndexed":4,"addedLines":["overview: \"Make Select Mode behave like Choose Model: (1) Ctrl+K opens the mode dialog directly in chat, (2) keep Select Mode in the command palette (Ctrl+P), (3) avoid sending an empty prompt after choosing a mode, and (4) show the current mode in the header bar.\""],"tokenizedAddedLines":[1000068]},{"originalStartLineNumberOneIndexed":8,"originalEndLineNumberExclusiveOneIndexed":9,"modifiedStartLineNumberOneIndexed":8,"modifiedEndLineNumberExclusiveOneIndexed":9,"addedLines":["# Fix mode selection flow (like Choose Model)"],"tokenizedAddedLines":[1000069]},{"originalStartLineNumberOneIndexed":12,"originalEndLineNumberExclusiveOneIndexed":14,"modifiedStartLineNumberOneIndexed":12,"modifiedEndLineNumberExclusiveOneIndexed":14,"addedLines":["1. **Select Mode should behave like Choose Model** — User wants to press **Ctrl+K** to change mode directly in the chat (open mode dialog), and **also** be able to choose \"Select Mode\" from the command palette (Ctrl+P). Right now mode is only reachable via the palette.","2. **After choosing mode, app jumps to response and errors \"prompt is empty\"** — When mode is chosen (from palette or via Ctrl+K), there is often no pending message. The handler still calls `sendMessageAfterSession(\"\", nil)`, which triggers the agent and returns `ErrEmptyPrompt`."],"tokenizedAddedLines":[1000070,1000071]},{"originalStartLineNumberOneIndexed":18,"originalEndLineNumberExclusiveOneIndexed":20,"modifiedStartLineNumberOneIndexed":18,"modifiedEndLineNumberExclusiveOneIndexed":20,"addedLines":["- **Mode dialog (like Model dialog):** **Ctrl+K** opens the mode selection dialog directly (same pattern as Ctrl+L/Ctrl+M for models). **Command palette** (Ctrl+P) still includes \"Select Mode\" so users can open the same dialog from the palette.","- **After choosing a mode:** Show the session with **current mode visible in the bar**; **do not** send a message when the prompt is empty. User types a prompt and presses Enter to send."],"tokenizedAddedLines":[1000072,1000073]},{"originalStartLineNumberOneIndexed":23,"originalEndLineNumberExclusiveOneIndexed":24,"modifiedStartLineNumberOneIndexed":23,"modifiedEndLineNumberExclusiveOneIndexed":26,"addedLines":["## 1. Add Ctrl+K as direct shortcut to open mode dialog (like Choose Model)","","Mirror the Models keybinding and handler: a dedicated key opens the mode dialog; the command palette continues to offer \"Select Mode\" as an alternative."],"tokenizedAddedLines":[1000074,6,1000075]},{"originalStartLineNumberOneIndexed":26,"originalEndLineNumberExclusiveOneIndexed":27,"modifiedStartLineNumberOneIndexed":28,"modifiedEndLineNumberExclusiveOneIndexed":37,"addedLines":["  - **Commands** binding: use only `key.WithKeys(\"ctrl+p\")` and `key.WithHelp(\"ctrl+p\", \"commands\")` (remove `\"ctrl+k\"` from Commands so the palette is Ctrl+P only).","  - **Add** a new binding `Mode` (or `SelectMode`): `key.WithKeys(\"ctrl+k\")`, `key.WithHelp(\"ctrl+k\", \"mode\")`. Same pattern as `Models`.","- **[internal/tui/tui.go](internal/tui/tui.go)**  ","  - **Add** a case for `key.Matches(msg, a.keyMap.Mode)` (after the Models case, same structure):","    - If not configured, return nil.","    - If mode dialog is already active, send `CloseDialogMsg`.","    - If another dialog is open, return nil.","    - Else send `OpenDialogMsg{ Model: mode.NewModeDialogCmp() }`.","  - Ensure `mode` package is imported (already is from SelectModeMsg)."],"tokenizedAddedLines":[1000076,1000077,1000078,1000079,1000080,1000081,1000082,1000083,1000084]},{"originalStartLineNumberOneIndexed":28,"originalEndLineNumberExclusiveOneIndexed":29,"modifiedStartLineNumberOneIndexed":38,"modifiedEndLineNumberExclusiveOneIndexed":39,"addedLines":["  - In the help / bindings section (~1241): keep Commands as `ctrl+p` only; **add** a binding for mode with `key.WithKeys(\"ctrl+k\")` and `key.WithHelp(\"ctrl+k\", \"mode\")` so the status bar shows the shortcut."],"tokenizedAddedLines":[1000085]},{"originalStartLineNumberOneIndexed":30,"originalEndLineNumberExclusiveOneIndexed":31,"modifiedStartLineNumberOneIndexed":40,"modifiedEndLineNumberExclusiveOneIndexed":41,"addedLines":["  - For the \"Select Mode\" command: set `Shortcut: \"ctrl+k\"` (so the palette entry documents the direct shortcut). Keep the handler as `SelectModeMsg` so the app can open the mode dialog from the palette as well."],"tokenizedAddedLines":[1000086]},{"originalStartLineNumberOneIndexed":63,"originalEndLineNumberExclusiveOneIndexed":70,"modifiedStartLineNumberOneIndexed":73,"modifiedEndLineNumberExclusiveOneIndexed":81,"addedLines":["| File                                                                                                         | Change                                                                                                                                                        |","| ------------------------------------------------------------------------------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------- |","| [internal/tui/keys.go](internal/tui/keys.go)                                                                 | Commands: `ctrl+p` only. **Add** `Mode` binding with `ctrl+k`, help `\"ctrl+k\", \"mode\"`.                                                                       |","| [internal/tui/tui.go](internal/tui/tui.go)                                                                   | **Add** case for `a.keyMap.Mode`: open/close mode dialog (same pattern as Models).                                                                            |","| [internal/tui/page/chat/chat.go](internal/tui/page/chat/chat.go)                                             | Commands help ctrl+p only. **Add** mode binding (ctrl+k) to help. SessionCreatedWithModeMsg: send only if text or attachments; focus editor when not sending. |","| [internal/tui/components/dialogs/commands/commands.go](internal/tui/components/dialogs/commands/commands.go) | Select Mode: keep `Shortcut: \"ctrl+k\"` so palette shows the direct shortcut.                                                                                  |","| [internal/tui/components/dialogs/mode/mode.go](internal/tui/components/dialogs/mode/mode.go)                 | Add `DisplayName(modeID string) string`.                                                                                                                      |","| [internal/tui/components/chat/header/header.go](internal/tui/components/chat/header/header.go)               | Import mode; in `details()`, show mode label when `session.Mode != \"\"`.                                                                                       |"],"tokenizedAddedLines":[1000087,1000088,1000089,1000090,1000091,1000092,1000093,1000094]},{"originalStartLineNumberOneIndexed":75,"originalEndLineNumberExclusiveOneIndexed":75,"modifiedStartLineNumberOneIndexed":86,"modifiedEndLineNumberExclusiveOneIndexed":93,"addedLines":["","Two ways to open the mode dialog (same as Choose Model):","","- **Direct:** User presses **Ctrl+K** → app opens mode dialog.","- **Via palette:** User presses **Ctrl+P** → command palette → \"Select Mode\" → app opens mode dialog (SelectModeMsg).","","After mode is chosen, flow is the same: ModeSelectedMsg → createSessionWithModeAndSend → SessionCreatedWithModeMsg; only send if text/attachments non-empty; header shows current mode."],"tokenizedAddedLines":[6,1000095,6,1000096,1000097,6,1000098]},{"originalStartLineNumberOneIndexed":80,"originalEndLineNumberExclusiveOneIndexed":81,"modifiedStartLineNumberOneIndexed":98,"modifiedEndLineNumberExclusiveOneIndexed":98},{"originalStartLineNumberOneIndexed":85,"originalEndLineNumberExclusiveOneIndexed":89,"modifiedStartLineNumberOneIndexed":102,"modifiedEndLineNumberExclusiveOneIndexed":103,"addedLines":["  User->>App: ctrl+k or ctrl+p then Select Mode"],"tokenizedAddedLines":[1000099]},{"originalStartLineNumberOneIndexed":101,"originalEndLineNumberExclusiveOneIndexed":104,"modifiedStartLineNumberOneIndexed":115,"modifiedEndLineNumberExclusiveOneIndexed":116,"addedLines":["No documentation change is required unless you want to update DEVELOPMENT.md (e.g. document Ctrl+K for mode, Ctrl+P for palette)."],"tokenizedAddedLines":[1000100]}],"gitInfo":{"noRepoFound":true},"kind":"KIND_MODIFIED"}